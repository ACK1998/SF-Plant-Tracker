const { FARM_OVERLAY, pixelToLngLat } = require('../constants/farmOverlay');

const generateRange = (start, end) =>
  Array.from({ length: end - start + 1 }, (_, index) => start + index);

const plotNumbers = [
  ...generateRange(1, 109),
  ...generateRange(200, 260),
  ...generateRange(300, 347),
];

const getPlaceholderPixel = (index, total) => {
  const cols = Math.ceil(Math.sqrt(total));
  const rows = Math.ceil(total / cols);
  const col = index % cols;
  const row = Math.floor(index / cols);

  const x = Math.floor((col + 0.5) * (FARM_OVERLAY.imageSize.width / cols));
  const y = Math.floor((row + 0.5) * (FARM_OVERLAY.imageSize.height / rows));
  return { x, y };
};

const domains = [
  {
    key: 'sf3',
    name: 'SF3',
    label: 'SF3',
    location: 'Sanctity Ferme Phase 3',
    description: 'Autogenerated from farm layout overlay',
    pixel: getPlaceholderPixel(0, 1),
    radiusMeters: 260,
  },
];

const MIN_PLOT_AREA_SQFT = 10000;

const ensureClosedRing = (ring) => {
  if (!ring.length) return ring;
  const first = ring[0];
  const last = ring[ring.length - 1];
  if (first.x === last.x && first.y === last.y) {
    return ring;
  }
  return [...ring, { ...first }];
};

const createGridCoordinates = ({
  codes,
  startX,
  startY,
  columns,
  size,
  gapX = 0,
  gapY = 0,
}) => {
  const half = size / 2;
  const strideX = size + gapX;
  const strideY = size + gapY;

  return codes.map((code, index) => {
    const col = index % columns;
    const row = Math.floor(index / columns);
    const x = startX + col * strideX;
    const y = startY + row * strideY;
    const polygon = ensureClosedRing([
      { x: x - half, y: y - half },
      { x: x + half, y: y - half },
      { x: x + half, y: y + half },
      { x: x - half, y: y + half },
    ]);
    return { code, pixel: { x, y }, polygon };
  });
};

const gridOne = createGridCoordinates({
  codes: plotNumbers.slice(0, 109),
  startX: 1800,
  startY: 4700,
  columns: 15,
  size: 220,
  gapX: 20,
  gapY: 30,
});

const gridTwo = createGridCoordinates({
  codes: plotNumbers.slice(109, 109 + 61),
  startX: 900,
  startY: 3400,
  columns: 11,
  size: 220,
  gapX: 25,
  gapY: 35,
});

const gridThree = createGridCoordinates({
  codes: plotNumbers.slice(109 + 61),
  startX: 10250,
  startY: 16000,
  columns: 12,
  size: 220,
  gapX: 25,
  gapY: 35,
});

const plots = [...gridOne, ...gridTwo, ...gridThree].map((plot) => {
  const polygon = plot.polygon;

  return {
    code: String(plot.code),
    name: `Plot ${plot.code}`,
    description: `Placeholder polygon derived from overlay for plot ${plot.code}`,
    pixel: plot.pixel,
    sizeSqFt: MIN_PLOT_AREA_SQFT,
    centroid: pixelToLngLat(plot.pixel.x, plot.pixel.y),
    polygonLngLat: polygon.map((coord) => pixelToLngLat(coord.x, coord.y)),
  };
});

module.exports = {
  domains: domains.map((domain) => ({
    ...domain,
    centroid: pixelToLngLat(domain.pixel.x, domain.pixel.y),
  })),
  plots,
};

