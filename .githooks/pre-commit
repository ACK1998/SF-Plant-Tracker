#!/bin/bash
# Pre-commit hook to prevent committing credentials

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running security checks...${NC}"

# Check for common password patterns
if git diff --cached | grep -iE "(password|passwd|pwd)\s*[:=]\s*['\"][^'\"]{3,}['\"]" > /dev/null; then
    echo -e "${RED}❌ ERROR: Potential password detected in staged files!${NC}"
    echo -e "${RED}Please remove hardcoded passwords and use environment variables instead.${NC}"
    exit 1
fi

# Check for common API key patterns
if git diff --cached | grep -iE "(api[_-]?key|secret[_-]?key|access[_-]?token)\s*[:=]\s*['\"][^'\"]{10,}['\"]" > /dev/null; then
    echo -e "${RED}❌ ERROR: Potential API key or secret detected in staged files!${NC}"
    echo -e "${RED}Please use environment variables instead.${NC}"
    exit 1
fi

# Check for MongoDB connection strings with credentials
if git diff --cached | grep -iE "mongodb[+]srv://[^:]+:[^@]+@" > /dev/null; then
    echo -e "${RED}❌ ERROR: MongoDB connection string with credentials detected!${NC}"
    echo -e "${RED}Please use environment variables for database connection strings.${NC}"
    exit 1
fi

# Check for .env files being committed
if git diff --cached --name-only | grep -E "\.env$|\.env\.(local|production|development|test)$" > /dev/null; then
    echo -e "${RED}❌ ERROR: .env file detected in staged files!${NC}"
    echo -e "${RED}.env files should never be committed. Use .env.example instead.${NC}"
    exit 1
fi

# Check for credential files
if git diff --cached --name-only | grep -iE "(password|secret|credential|key).*\.(js|ts|txt|json)$" > /dev/null; then
    echo -e "${YELLOW}⚠️  WARNING: File with credential-related name detected.${NC}"
    echo -e "${YELLOW}Please verify this file does not contain sensitive information.${NC}"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo -e "${GREEN}✅ Security checks passed!${NC}"
exit 0
